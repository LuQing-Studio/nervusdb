# [Phase-C] å·¥ç¨‹åŒ–ä¸è´¨é‡æå‡

**æ—¶é—´å‘¨æœŸ**ï¼š2025å¹´2æœˆç¬¬4å‘¨-3æœˆç¬¬1å‘¨ï¼ˆ2å‘¨ï¼‰
**ä¼˜å…ˆçº§**ï¼šP2ï¼ˆé‡è¦ï¼‰
**å‰ç½®ä¾èµ–**ï¼šPhase-Aã€Phase-B å®Œæˆ
**ç›®æ ‡**ï¼šæå‡é¡¹ç›®è´¨é‡ã€å¼€å‘ä½“éªŒå’Œå¯ç»´æŠ¤æ€§

## ğŸ“Š ä»»åŠ¡æ¸…å•

### 1. æ€§èƒ½åŸºå‡†æµ‹è¯•å¥—ä»¶ â­â­â­â­â­

#### 1.1 éœ€æ±‚åˆ†æ

- **ç°çŠ¶**ï¼šç¼ºå°‘ç³»ç»ŸåŒ–çš„æ€§èƒ½æµ‹è¯•ï¼Œéš¾ä»¥å‘ç°æ€§èƒ½é€€åŒ–
- **ç›®æ ‡**ï¼šå»ºç«‹è‡ªåŠ¨åŒ–æ€§èƒ½åŸºå‡†ï¼ŒæŒç»­ç›‘æ§æ€§èƒ½æŒ‡æ ‡
- **ä»·å€¼**ï¼šåŠæ—¶å‘ç°æ€§èƒ½é—®é¢˜ï¼Œä¿è¯ç³»ç»Ÿç¨³å®šæ€§

#### 1.2 åŸºå‡†æµ‹è¯•è®¾è®¡

```typescript
// æ€§èƒ½æµ‹è¯•æ¡†æ¶
interface BenchmarkSuite {
  name: string;
  setup: () => Promise<void>;
  teardown: () => Promise<void>;
  benchmarks: Benchmark[];
}

interface Benchmark {
  name: string;
  dataSize: number;
  iterations: number;
  run: () => Promise<void>;
  expectedMetrics: {
    maxDuration?: number; // æœ€å¤§æ‰§è¡Œæ—¶é—´ (ms)
    maxMemory?: number; // æœ€å¤§å†…å­˜ä½¿ç”¨ (MB)
    minOps?: number; // æœ€å°æ“ä½œæ•°/ç§’
  };
}

// åŸºå‡†æµ‹è¯•è¿è¡Œå™¨
class BenchmarkRunner {
  async run(suite: BenchmarkSuite): Promise<BenchmarkResult> {
    await suite.setup();

    const results: BenchmarkResult[] = [];

    for (const benchmark of suite.benchmarks) {
      // é¢„çƒ­
      await this.warmup(benchmark);

      // æ”¶é›†æŒ‡æ ‡
      const metrics = await this.measurePerformance(benchmark);

      // éªŒè¯æŒ‡æ ‡
      const passed = this.validateMetrics(metrics, benchmark.expectedMetrics);

      results.push({
        name: benchmark.name,
        metrics,
        passed,
        regression: this.detectRegression(metrics),
      });
    }

    await suite.teardown();
    return this.generateReport(results);
  }
}
```

#### 1.3 æµ‹è¯•åœºæ™¯è®¾è®¡

```typescript
// 1. å†™å…¥æ€§èƒ½æµ‹è¯•
const writePerformance: BenchmarkSuite = {
  name: 'Write Performance',
  benchmarks: [
    {
      name: 'Sequential Writes',
      dataSize: 100000,
      run: async () => {
        for (let i = 0; i < 100000; i++) {
          await db.addFact({
            subject: `s${i}`,
            predicate: 'rel',
            object: `o${i}`
          });
        }
      },
      expectedMetrics: {
        minOps: 10000  // è‡³å°‘ 10K ops/s
      }
    },
    {
      name: 'Batch Writes',
      dataSize: 100000,
      run: async () => {
        for (let batch = 0; batch < 100; batch++) {
          db.beginBatch();
          for (let i = 0; i < 1000; i++) {
            db.addFact({...});
          }
          await db.commitBatch();
        }
      },
      expectedMetrics: {
        minOps: 50000  // æ‰¹é‡å†™å…¥åº”æ›´å¿«
      }
    }
  ]
};

// 2. æŸ¥è¯¢æ€§èƒ½æµ‹è¯•
const queryPerformance: BenchmarkSuite = {
  name: 'Query Performance',
  benchmarks: [
    {
      name: 'Point Query',
      expectedMetrics: { maxDuration: 10 }
    },
    {
      name: '3-Hop Traversal',
      expectedMetrics: { maxDuration: 100 }
    },
    {
      name: 'Property Filter',
      expectedMetrics: { maxDuration: 50 }
    },
    {
      name: 'Aggregation',
      expectedMetrics: { maxDuration: 200 }
    }
  ]
};

// 3. å†…å­˜æ•ˆç‡æµ‹è¯•
const memoryEfficiency: BenchmarkSuite = {
  name: 'Memory Efficiency',
  benchmarks: [
    {
      name: 'Large Dataset Query',
      dataSize: 1000000,
      run: async () => {
        // ä½¿ç”¨æµå¼æŸ¥è¯¢
        for await (const batch of db.stream({}, 1000)) {
          // å¤„ç†æ‰¹æ¬¡
        }
      },
      expectedMetrics: {
        maxMemory: 100  // æœ€å¤§ 100MB
      }
    }
  ]
};
```

#### 1.4 å®æ–½ä»»åŠ¡

- [ ] åˆ›å»º `benchmarks/` ç›®å½•ç»“æ„
- [ ] å®ç°æ€§èƒ½æµ‹è¯•æ¡†æ¶
- [ ] ç¼–å†™æ ¸å¿ƒæ€§èƒ½æµ‹è¯•ç”¨ä¾‹
- [ ] é›†æˆå†…å­˜ç›‘æ§ (heapdump)
- [ ] CI/CD é›†æˆï¼Œè‡ªåŠ¨è¿è¡Œ
- [ ] å†å²æ•°æ®è¿½è¸ªä¸å¯¹æ¯”

---

### 2. TypeScript ç±»å‹ç³»ç»Ÿå¢å¼º â­â­â­â­

#### 2.1 éœ€æ±‚åˆ†æ

- **ç°çŠ¶**ï¼šç±»å‹å®šä¹‰ä¸å¤Ÿç²¾ç¡®ï¼ŒIDE æç¤ºä¸å¤Ÿæ™ºèƒ½
- **ç›®æ ‡**ï¼šæä¾›å®Œæ•´çš„ç±»å‹å®‰å…¨å’Œæ™ºèƒ½æç¤º
- **ä»·å€¼**ï¼šå‡å°‘è¿è¡Œæ—¶é”™è¯¯ï¼Œæå‡å¼€å‘æ•ˆç‡

#### 2.2 ç±»å‹æ”¹è¿›æ–¹æ¡ˆ

```typescript
// 1. æ³›å‹åŒ–æ ¸å¿ƒç±»
export class SynapseDB<
  TNodeProps extends Record<string, any> = any,
  TEdgeProps extends Record<string, any> = any,
> {
  addFact(
    fact: FactInput,
    properties?: {
      subjectProperties?: TNodeProps;
      objectProperties?: TNodeProps;
      edgeProperties?: TEdgeProps;
    },
  ): void;

  find<T extends FactCriteria>(criteria: T): QueryBuilder<TNodeProps, TEdgeProps, T>;

  getNodeProperties(nodeId: number): TNodeProps | null;
  getEdgeProperties(key: string): TEdgeProps | null;
}

// 2. æŸ¥è¯¢æ„å»ºå™¨ç±»å‹æ¨æ–­
export class QueryBuilder<TNodeProps, TEdgeProps, TCriteria extends FactCriteria> {
  // æ¨æ–­ where å›è°ƒå‚æ•°ç±»å‹
  where(
    predicate: (record: InferredFactRecord<TCriteria, TNodeProps, TEdgeProps>) => boolean,
  ): this;

  // é“¾å¼è°ƒç”¨ä¿æŒç±»å‹
  follow(predicate: string): QueryBuilder<TNodeProps, TEdgeProps, FollowCriteria>;

  // è¿”å›æ­£ç¡®ç±»å‹çš„ç»“æœ
  all(): InferredFactRecord<TCriteria, TNodeProps, TEdgeProps>[];

  // å¼‚æ­¥è¿­ä»£å™¨ç±»å‹
  [Symbol.asyncIterator](): AsyncIterator<InferredFactRecord<TCriteria, TNodeProps, TEdgeProps>>;
}

// 3. æ¡ä»¶ç±»å‹æ¨æ–­
type InferredFactRecord<
  TCriteria extends FactCriteria,
  TNodeProps,
  TEdgeProps,
> = TCriteria extends { subject: string }
  ? FactRecordWithSubject<TNodeProps, TEdgeProps>
  : TCriteria extends { object: string }
    ? FactRecordWithObject<TNodeProps, TEdgeProps>
    : FactRecord<TNodeProps, TEdgeProps>;

// 4. å·¥å…·ç±»å‹
type DeepPartial<T> = {
  [P in keyof T]?: T[P] extends object ? DeepPartial<T[P]> : T[P];
};

type RequireAtLeastOne<T> = {
  [K in keyof T]: Required<Pick<T, K>> & Partial<Omit<T, K>>;
}[keyof T];
```

#### 2.3 ä½¿ç”¨ç¤ºä¾‹

```typescript
// å®šä¹‰æ•°æ®æ¨¡å‹
interface UserProps {
  name: string;
  age: number;
  email?: string;
}

interface RelationProps {
  since: Date;
  strength: number;
}

// åˆ›å»ºç±»å‹å®‰å…¨çš„æ•°æ®åº“
const db = await SynapseDB.open<UserProps, RelationProps>('./db.synapsedb');

// ç±»å‹å®‰å…¨çš„å†™å…¥
db.addFact(
  { subject: 'alice', predicate: 'KNOWS', object: 'bob' },
  {
    subjectProperties: {
      name: 'Alice',
      age: 30, // TypeScript ä¼šæ£€æŸ¥ç±»å‹
    },
    edgeProperties: {
      since: new Date('2020-01-01'),
      strength: 0.8,
    },
  },
);

// æ™ºèƒ½çš„æŸ¥è¯¢æç¤º
const result = db
  .find({ predicate: 'KNOWS' })
  .where((r) => r.edgeProperties?.strength > 0.5) // è‡ªåŠ¨æ¨æ–­ç±»å‹
  .all();
```

#### 2.4 å®æ–½ä»»åŠ¡

- [ ] é‡æ„æ ¸å¿ƒç±»æ·»åŠ æ³›å‹
- [ ] å®ç°æ¡ä»¶ç±»å‹æ¨æ–­
- [ ] æ·»åŠ å·¥å…·ç±»å‹å®šä¹‰
- [ ] æ›´æ–°æ‰€æœ‰ API ç­¾å
- [ ] ç¼–å†™ç±»å‹æµ‹è¯•ç”¨ä¾‹
- [ ] æ›´æ–° d.ts å£°æ˜æ–‡ä»¶

---

### 3. æ–‡æ¡£ä¸ç¤ºä¾‹å®Œå–„ â­â­â­â­

#### 3.1 æ–‡æ¡£ç»“æ„è§„åˆ’

```markdown
docs/
â”œâ”€â”€ getting-started/
â”‚ â”œâ”€â”€ installation.md
â”‚ â”œâ”€â”€ quick-start.md
â”‚ â””â”€â”€ basic-concepts.md
â”œâ”€â”€ guides/
â”‚ â”œâ”€â”€ querying.md
â”‚ â”œâ”€â”€ transactions.md
â”‚ â”œâ”€â”€ performance-tuning.md
â”‚ â””â”€â”€ migration-guide.md
â”œâ”€â”€ api-reference/
â”‚ â”œâ”€â”€ database.md
â”‚ â”œâ”€â”€ query-builder.md
â”‚ â”œâ”€â”€ aggregation.md
â”‚ â””â”€â”€ utilities.md
â”œâ”€â”€ examples/
â”‚ â”œâ”€â”€ social-network/
â”‚ â”œâ”€â”€ knowledge-graph/
â”‚ â”œâ”€â”€ dependency-analysis/
â”‚ â””â”€â”€ real-time-analytics/
â””â”€â”€ internals/
â”œâ”€â”€ architecture.md
â”œâ”€â”€ storage-format.md
â””â”€â”€ indexing-strategy.md
```

#### 3.2 ç¤ºä¾‹é¡¹ç›®

```typescript
// examples/social-network/index.ts
import { SynapseDB } from 'synapsedb';

// ç¤¾äº¤ç½‘ç»œç¤ºä¾‹
async function socialNetworkExample() {
  const db = await SynapseDB.open('./social.db');

  // 1. åˆ›å»ºç”¨æˆ·å…³ç³»å›¾
  const users = ['Alice', 'Bob', 'Charlie', 'David', 'Eve'];
  const relationships = [
    ['Alice', 'Bob', 0.9],
    ['Bob', 'Charlie', 0.7],
    ['Charlie', 'David', 0.8],
    ['David', 'Eve', 0.6],
    ['Alice', 'Eve', 0.5],
  ];

  for (const [from, to, strength] of relationships) {
    db.addFact({ subject: from, predicate: 'KNOWS', object: to }, { edgeProperties: { strength } });
  }

  // 2. æŸ¥è¯¢ç¤ºä¾‹

  // æ‰¾å‡ºAliceçš„æ‰€æœ‰æœ‹å‹
  const friends = db.find({ subject: 'Alice', predicate: 'KNOWS' }).all();

  // æ‰¾å‡ºé€šè¿‡2-3è·³èƒ½è®¤è¯†çš„äºº
  const network = db.find({ subject: 'Alice' }).followPath('KNOWS', { min: 2, max: 3 }).all();

  // æ‰¾å‡ºæœ€å—æ¬¢è¿çš„äººï¼ˆè¢«æœ€å¤šäººè®¤è¯†ï¼‰
  const popular = db
    .aggregate()
    .match({ predicate: 'KNOWS' })
    .groupBy(['object'])
    .count('inDegree')
    .sort('inDegree', 'desc')
    .limit(1)
    .execute();

  // 3. ç¤¾åŒºå‘ç°
  const communities = await detectCommunities(db);

  // 4. æ¨èç³»ç»Ÿ
  const recommendations = await recommendFriends(db, 'Alice');
}
```

#### 3.3 API æ–‡æ¡£ç”Ÿæˆ

```json
// typedoc.json
{
  "entryPoints": ["src/index.ts"],
  "out": "docs/api",
  "plugin": ["typedoc-plugin-markdown"],
  "theme": "markdown",
  "readme": "README.md",
  "excludePrivate": true,
  "excludeInternal": true,
  "categorizeByGroup": true,
  "navigation": {
    "includeCategories": true,
    "includeGroups": true
  }
}
```

#### 3.4 å®æ–½ä»»åŠ¡

- [ ] åˆ›å»ºæ–‡æ¡£ç›®å½•ç»“æ„
- [ ] ç¼–å†™å…¥é—¨æŒ‡å—
- [ ] å®Œå–„ API å‚è€ƒæ–‡æ¡£
- [ ] åˆ›å»º 3-5 ä¸ªå®Œæ•´ç¤ºä¾‹
- [ ] æ·»åŠ æ€§èƒ½è°ƒä¼˜æŒ‡å—
- [ ] é…ç½®æ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆ

---

## ğŸ“ˆ è´¨é‡æŒ‡æ ‡

| æŒ‡æ ‡               | å½“å‰å€¼ | ç›®æ ‡å€¼ |
| ------------------ | ------ | ------ |
| æµ‹è¯•è¦†ç›–ç‡         | 75%    | 85%    |
| TypeScriptä¸¥æ ¼æ¨¡å¼ | éƒ¨åˆ†   | å®Œå…¨   |
| æ–‡æ¡£å®Œæ•´åº¦         | 60%    | 95%    |
| ç¤ºä¾‹é¡¹ç›®           | 1ä¸ª    | 5ä¸ª    |
| æ€§èƒ½å›å½’æ£€æµ‹       | æ—      | è‡ªåŠ¨åŒ– |

## ğŸ§ª æµ‹è¯•è®¡åˆ’

### ç±»å‹æµ‹è¯•

```typescript
// test-types.ts
import { expectType } from 'tsd';

// æµ‹è¯•ç±»å‹æ¨æ–­
const db = await SynapseDB.open<User, Relation>('./test.db');
const result = db.find({ subject: 'alice' }).all();
expectType<FactRecord<User, Relation>[]>(result);
```

### æ–‡æ¡£æµ‹è¯•

```bash
# éªŒè¯ç¤ºä¾‹ä»£ç å¯è¿è¡Œ
pnpm test:examples

# æ£€æŸ¥æ–‡æ¡£é“¾æ¥
pnpm docs:check-links

# ç”Ÿæˆ API æ–‡æ¡£
pnpm docs:generate
```

## ğŸ“ äº¤ä»˜ç‰©æ¸…å•

### æ€§èƒ½åŸºå‡†

- [ ] æ€§èƒ½æµ‹è¯•æ¡†æ¶å®ç°
- [ ] 10+ æ ¸å¿ƒæ€§èƒ½æµ‹è¯•
- [ ] CI/CD é›†æˆé…ç½®
- [ ] æ€§èƒ½æŠ¥å‘Šæ¨¡æ¿

### TypeScript

- [ ] å®Œæ•´çš„ç±»å‹å®šä¹‰
- [ ] .d.ts å£°æ˜æ–‡ä»¶
- [ ] ç±»å‹æµ‹è¯•ç”¨ä¾‹
- [ ] è¿ç§»æŒ‡å—

### æ–‡æ¡£

- [ ] å®Œæ•´çš„ç”¨æˆ·æŒ‡å—
- [ ] API å‚è€ƒæ–‡æ¡£
- [ ] 5ä¸ªç¤ºä¾‹é¡¹ç›®
- [ ] æ¶æ„è®¾è®¡æ–‡æ¡£

## âœ… å®Œæˆæ ‡å‡†

- [ ] æ€§èƒ½åŸºå‡†è‡ªåŠ¨åŒ–è¿è¡Œ
- [ ] TypeScript strict mode é€šè¿‡
- [ ] æ–‡æ¡£è¦†ç›–æ‰€æœ‰å…¬å…±API
- [ ] ç¤ºä¾‹å¯ç‹¬ç«‹è¿è¡Œ
- [ ] é›¶ TODO/FIXME æ³¨é‡Š

## ğŸš€ åç»­è§„åˆ’

å®Œæˆ Phase A-C åï¼Œé¡¹ç›®å°†è¾¾åˆ° v1.1.0 çš„ç”Ÿäº§å°±ç»ªçŠ¶æ€ï¼Œå¯ä»¥ï¼š

1. å‘å¸ƒæ­£å¼ç‰ˆæœ¬
2. å¼€å§‹ç¤¾åŒºæ¨å¹¿
3. æ”¶é›†ç”¨æˆ·åé¦ˆ
4. è§„åˆ’ v1.2.0 åŠŸèƒ½
