# 04 · 事务与幂等（批次/耐久）

```ts
import { SynapseDB } from 'synapsedb';

const db = await SynapseDB.open('tx.synapsedb', {
  enableLock: true,
  // 按需开启跨周期幂等（可选）
  enablePersistentTxDedupe: true,
  maxRememberTxIds: 2000,
});

// 幂等写入：以订单号作为 txId
const txId = 'ORDER-2025-0001';
db.beginBatch({ txId, sessionId: 'svc-a' });
try {
  db.addFact({ subject: 'user:1001', predicate: 'ORDERED', object: 'order:2025-0001' });
  db.addFact({ subject: 'order:2025-0001', predicate: 'CONTAINS', object: 'product:SKU-1' });
  db.commitBatch({ durable: true }); // 更强持久保障
} catch (e) {
  db.abortBatch();
  throw e;
}

await db.flush();
await db.close();
```

要点

- `beginBatch/commitBatch/abortBatch`：同一批次原子提交
- `durable: true`：提交即 fsync 落盘
- 幂等：开启 `enablePersistentTxDedupe` + 为重试使用相同 txId
