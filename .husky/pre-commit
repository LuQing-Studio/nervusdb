#!/usr/bin/env sh
set -e

echo "[husky] pre-commit: update docs directory tree"
pnpm run docs:tree

# 若目录树更新，则将修改加入暂存区，确保随本次提交生效
if ! git diff --quiet -- .agents/rules/base.md; then
  git add .agents/rules/base.md
fi

echo "[husky] pre-commit: lint-staged"
pnpm exec lint-staged -c .lintstaged.cjs

echo "[husky] pre-commit: lint (full)"
pnpm run lint

echo "[husky] pre-commit: prettier format write"
pnpm run format:write

# 将格式化产生的变更加入本次提交
git add README.md docs/**/*.md .agents/**/*.md .github/**/*.yml package.json || true

# 仅当提交中包含源码/测试改动时，才运行完整 CI（含覆盖率门槛）
CHANGED_FILES=$(git diff --cached --name-only)
if echo "$CHANGED_FILES" | grep -Eq '^(src/|tests/|vitest\.config\.ts$|tsconfig.*|eslint\.config\.js$)'; then
  echo "[husky] pre-commit: full CI with coverage (typecheck + lint + test:coverage + build)"
  pnpm run ci
else
  echo "[husky] pre-commit: skip full CI (no src/tests changes)"
fi
