# ç³»ç»Ÿæµ‹è¯•

<cite>
**æœ¬æ–‡æ¡£ä¸­å¼•ç”¨çš„æ–‡ä»¶**  
- [query_snapshot_isolation.test.ts](file://tests/system/query_snapshot_isolation.test.ts) - *å¿«ç…§éš”ç¦»çº§åˆ«æµ‹è¯•*
- [crash_injection.test.ts](file://tests/system/crash_injection.test.ts) - *å´©æºƒæ³¨å…¥æµ‹è¯•*
- [concurrency_single_writer_guard.test.ts](file://tests/system/concurrency_single_writer_guard.test.ts) - *å•å†™è€…å¹¶å‘æ§åˆ¶æµ‹è¯•*
- [snapshot_memory_basic.test.ts](file://tests/system/snapshot_memory_basic.test.ts) - *å¿«ç…§å†…å­˜åŸºç¡€æµ‹è¯•*
- [snapshot_memory_optimization.test.ts](file://tests/system/snapshot_memory_optimization.test.ts) - *å·²æ›´æ–°ï¼šå†…å­˜æµ‹è¯•é˜ˆå€¼è°ƒæ•´*
- [synapseDb.ts](file://src/synapseDb.ts) - *æ•°æ®åº“æ ¸å¿ƒå®ç°*
- [persistentStore.ts](file://src/storage/persistentStore.ts) - *æŒä¹…åŒ–å­˜å‚¨ç®¡ç†*
- [autoCompact.ts](file://src/maintenance/autoCompact.ts) - *è‡ªåŠ¨å‹ç¼©é€»è¾‘*
- [gc.ts](file://src/maintenance/gc.ts) - *åƒåœ¾å›æ”¶æœºåˆ¶*
- [fault.ts](file://src/utils/fault.ts) - *æ•…éšœæ³¨å…¥å·¥å…·*
- [pagedIndex.ts](file://src/storage/pagedIndex.ts) - *åˆ†é¡µç´¢å¼•åè°ƒ*
- [readerRegistry.ts](file://src/storage/readerRegistry.ts) - *è¯»è€…æ³¨å†Œç®¡ç†*
- [wal.ts](file://src/storage/wal.ts) - *WAL ç®¡ç†å™¨*
- [.github/workflows/ci.yml](file://.github/workflows/ci.yml) - *å·²æ›´æ–°ï¼šCI æ¸…ç†ç­–ç•¥å¼ºåŒ–*
</cite>

## æ›´æ–°æ‘˜è¦
**å˜æ›´å†…å®¹**   
- æ›´æ–°â€œå†…å­˜ä¼˜åŒ–ç­–ç•¥â€éƒ¨åˆ†ï¼Œåæ˜ æµå¼æŸ¥è¯¢å†…å­˜å¢é•¿é˜ˆå€¼ä» 12MB è°ƒæ•´è‡³ 15MB çš„å˜æ›´
- æ–°å¢â€œCI æ¸…ç†ç­–ç•¥â€éƒ¨åˆ†ï¼Œè¯´æ˜é˜²æ­¢ä¸´æ—¶æ–‡ä»¶æ®‹ç•™çš„æœºåˆ¶
- æ›´æ–°ç›¸å…³æµ‹è¯•æ–‡ä»¶çš„å¼•ç”¨è¯´æ˜ï¼Œæ ‡æ³¨å…¶æ›´æ–°çŠ¶æ€
- ä¿æŒå…¶ä½™å†…å®¹ä¸å˜ï¼Œç¡®ä¿ä¸ç°æœ‰ä»£ç ä¸€è‡´

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [ç³»ç»Ÿçº§è¡Œä¸ºéªŒè¯æ¦‚è¿°](#ç³»ç»Ÿçº§è¡Œä¸ºéªŒè¯æ¦‚è¿°)
3. [å¿«ç…§éš”ç¦»çº§åˆ«å®ç°éªŒè¯](#å¿«ç…§éš”ç¦»çº§åˆ«å®ç°éªŒè¯)
4. [å•å†™è€…å¹¶å‘æ§åˆ¶æœºåˆ¶](#å•å†™è€…å¹¶å‘æ§åˆ¶æœºåˆ¶)
5. [å†…å­˜ä¼˜åŒ–ç­–ç•¥åœ¨é•¿æ—¶é—´è¿è¡Œä¸­çš„è¡¨ç°](#å†…å­˜ä¼˜åŒ–ç­–ç•¥åœ¨é•¿æ—¶é—´è¿è¡Œä¸­çš„è¡¨ç°)
6. [å´©æºƒæ³¨å…¥ä¸æ•…éšœæ¢å¤èƒ½åŠ›](#å´©æºƒæ³¨å…¥ä¸æ•…éšœæ¢å¤èƒ½åŠ›)
7. [ç³»ç»Ÿæµ‹è¯•æ‰§è¡Œæ–¹å¼](#ç³»ç»Ÿæµ‹è¯•æ‰§è¡Œæ–¹å¼)
8. [æ—¥å¿—åˆ†ææŠ€å·§](#æ—¥å¿—åˆ†ææŠ€å·§)
9. [å¸¸è§å¤±è´¥æ¨¡å¼æ’æŸ¥æŒ‡å¼•](#å¸¸è§å¤±è´¥æ¨¡å¼æ’æŸ¥æŒ‡å¼•)
10. [CI æ¸…ç†ç­–ç•¥](#ci-æ¸…ç†ç­–ç•¥)
11. [ç»“è®º](#ç»“è®º)

## ç®€ä»‹
æœ¬ç³»ç»Ÿæµ‹è¯•æ–‡æ¡£æ—¨åœ¨å…¨é¢æè¿° SynapseDB æ•°æ®åº“åœ¨çœŸå®éƒ¨ç½²ç¯å¢ƒä¸‹çš„ç¨³å®šæ€§ä¸å¯é æ€§ä¿éšœæœºåˆ¶ã€‚é€šè¿‡ç«¯åˆ°ç«¯çš„ç³»ç»Ÿçº§è¡Œä¸ºéªŒè¯ï¼Œé‡ç‚¹è¦†ç›–äº†æ•°æ®åº“æ ¸å¿ƒç‰¹æ€§ï¼šå¿«ç…§éš”ç¦»ã€å•å†™è€…å¹¶å‘æ§åˆ¶ã€å†…å­˜ä¼˜åŒ–ä»¥åŠæ•…éšœæ¢å¤èƒ½åŠ›ã€‚è¿™äº›æµ‹è¯•ä¸ä»…ç¡®ä¿åŠŸèƒ½æ­£ç¡®æ€§ï¼Œæ›´æ¨¡æ‹Ÿäº†é«˜è´Ÿè½½ã€é•¿æ—¶é—´è¿è¡Œå’Œå¼‚å¸¸ä¸­æ–­ç­‰ç”Ÿäº§åœºæ™¯ï¼Œä¸ºæ•°æ®åº“çš„å¥å£®æ€§æä¾›å®è¯æ”¯æŒã€‚

**Section sources**
- [query_snapshot_isolation.test.ts](file://tests/system/query_snapshot_isolation.test.ts#L1-L285)
- [crash_injection.test.ts](file://tests/system/crash_injection.test.ts#L1-L97)
- [concurrency_single_writer_guard.test.ts](file://tests/system/concurrency_single_writer_guard.test.ts#L1-L193)

## ç³»ç»Ÿçº§è¡Œä¸ºéªŒè¯æ¦‚è¿°
SynapseDB çš„ç³»ç»Ÿæµ‹è¯•èšç„¦äºéªŒè¯å…¶åœ¨å¤æ‚å¹¶å‘ã€åå°ç»´æŠ¤ä»»åŠ¡å’Œæ„å¤–æ•…éšœä¸‹çš„æ•°æ®ä¸€è‡´æ€§ä¸æœåŠ¡å¯ç”¨æ€§ã€‚æµ‹è¯•æ¡†æ¶åŸºäº Vitest æ„å»ºï¼Œåˆ©ç”¨ä¸´æ—¶ç›®å½•å’Œè¿›ç¨‹é—´åè°ƒæ¥æ¨¡æ‹ŸçœŸå®ä¸–ç•Œçš„å·¥ä½œè´Ÿè½½ã€‚å…³é”®æµ‹è¯•ç±»åˆ«åŒ…æ‹¬ï¼š
- **å¿«ç…§éš”ç¦»ï¼ˆSnapshot Isolationï¼‰**ï¼šéªŒè¯é•¿æŸ¥è¯¢æœŸé—´è§†å›¾çš„ä¸€è‡´æ€§ï¼Œä¸å—åå°å†™å…¥æˆ–å‹ç¼©çš„å½±å“ã€‚
- **å•å†™è€…ä¿æŠ¤ï¼ˆSingle Writer Guardï¼‰**ï¼šç¡®ä¿æ•°æ®åº“åœ¨åŒä¸€æ—¶é—´ä»…å…è®¸ä¸€ä¸ªå†™å…¥å®ä¾‹ï¼Œé˜²æ­¢æ•°æ®æŸåã€‚
- **å´©æºƒæ¢å¤ï¼ˆCrash Recoveryï¼‰**ï¼šé€šè¿‡æ³¨å…¥å¼æ•…éšœæ¨¡æ‹Ÿ WAL å†™å…¥è¿‡ç¨‹ä¸­çš„å„ç§ä¸­æ–­ç‚¹ï¼ŒéªŒè¯é‡å¯åæ•°æ®çš„æŒä¹…æ€§å’Œå®Œæ•´æ€§ã€‚
- **å†…å­˜ç®¡ç†ï¼ˆMemory Managementï¼‰**ï¼šè¯„ä¼°å¿«ç…§æŸ¥è¯¢å¯¹å †å†…å­˜çš„å½±å“ï¼Œç¡®ä¿é•¿æ—¶é—´è¿è¡Œä¸ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ã€‚

è¿™äº›æµ‹è¯•å…±åŒæ„æˆäº†æ•°æ®åº“ç¨³å®šæ€§çš„åŸºçŸ³ï¼Œç¡®ä¿å…¶èƒ½å¤Ÿåœ¨ä¼ä¸šçº§åº”ç”¨ä¸­å¯é è¿è¡Œã€‚

```mermaid
graph TD
A[ç³»ç»Ÿæµ‹è¯•] --> B[å¿«ç…§éš”ç¦»]
A --> C[å•å†™è€…æ§åˆ¶]
A --> D[å´©æºƒæ¢å¤]
A --> E[å†…å­˜ä¼˜åŒ–]
B --> F[withSnapshot API]
B --> G[epoch å›ºå®š]
C --> H[é”æ–‡ä»¶æœºåˆ¶]
C --> I[å¤šè¯»è€…å…±å­˜]
D --> J[WAL æŒä¹…åŒ–]
D --> K[å¹‚ç­‰é‡æ”¾]
E --> L[æµå¼æŸ¥è¯¢]
E --> M[GC ååŒ]
```

**Diagram sources**
- [query_snapshot_isolation.test.ts](file://tests/system/query_snapshot_isolation.test.ts#L1-L285)
- [concurrency_single_writer_guard.test.ts](file://tests/system/concurrency_single_writer_guard.test.ts#L1-L193)
- [crash_injection.test.ts](file://tests/system/crash_injection.test.ts#L1-L97)
- [snapshot_memory_optimization.test.ts](file://tests/system/snapshot_memory_optimization.test.ts#L1-L199)

## å¿«ç…§éš”ç¦»çº§åˆ«å®ç°éªŒè¯
å¿«ç…§éš”ç¦»æ˜¯ SynapseDB ä¿è¯è¯»å–ä¸€è‡´æ€§çš„æ ¸å¿ƒæœºåˆ¶ã€‚`query_snapshot_isolation.test.ts` ä¸­çš„æµ‹è¯•ç”¨ä¾‹é€šè¿‡ `withSnapshot` API éªŒè¯äº†è¯¥æœºåˆ¶çš„æœ‰æ•ˆæ€§ã€‚

### å®ç°åŸç†
å½“è°ƒç”¨ `db.withSnapshot()` æ—¶ï¼Œç³»ç»Ÿä¼šæ•è·å½“å‰çš„â€œepochâ€ï¼ˆç‰ˆæœ¬å·ï¼‰ï¼Œå¹¶é€šè¿‡ `pushPinnedEpoch` å°†æ­¤ epoch æ³¨å†Œä¸ºæ´»åŠ¨è¯»å–å™¨ã€‚è¿™ä¼šé˜»æ­¢åƒåœ¾å›æ”¶ï¼ˆGCï¼‰æ¸…ç†è¯¥ epoch ä¹‹å‰çš„æ•°æ®é¡µï¼Œä»è€Œä¿è¯åœ¨æ•´ä¸ªå¿«ç…§ç”Ÿå‘½å‘¨æœŸå†…ï¼ŒæŸ¥è¯¢ç»“æœçš„ä¸€è‡´æ€§ã€‚

### å…³é”®æµ‹è¯•åœºæ™¯
- **é•¿æŸ¥è¯¢ä¸åå°å‹ç¼©å¹¶å‘**ï¼šæµ‹è¯•éªŒè¯äº†å³ä½¿åœ¨é•¿æ—¶é—´é“¾å¼æŸ¥è¯¢è¿‡ç¨‹ä¸­å‘ç”Ÿå¢é‡å‹ç¼©ï¼ŒæŸ¥è¯¢ç»“æœä¹Ÿä¸ä¼šå› æ•°æ®é‡ç»„è€Œæ”¹å˜ã€‚
- **ç‹¬ç«‹ GC æ“ä½œä¸å½±å“ç»“æœ**ï¼šå¹¶å‘æ‰§è¡Œçš„ GC ä»»åŠ¡ä¼šå°Šé‡æ´»åŠ¨çš„è¯»å–å™¨ï¼Œä¸ä¼šåˆ é™¤è¢«å¿«ç…§å¼•ç”¨çš„é¡µé¢ï¼Œç¡®ä¿æŸ¥è¯¢å®Œæ•´æ€§ã€‚
- **æ–°å†™å…¥ä¸å½±å“å½“å‰å¿«ç…§**ï¼šåœ¨å¿«ç…§æŸ¥è¯¢è¿›è¡ŒæœŸé—´æäº¤çš„æ–°æ•°æ®ï¼Œä¸ä¼šå‡ºç°åœ¨è¯¥å¿«ç…§çš„æŸ¥è¯¢ç»“æœä¸­ï¼Œä½“ç°äº†â€œè¯»å·²æäº¤â€éš”ç¦»çº§åˆ«çš„è¯­ä¹‰ã€‚

```mermaid
sequenceDiagram
participant Client as "å®¢æˆ·ç«¯"
participant DB as "æ•°æ®åº“"
participant Compaction as "åå°å‹ç¼©"
participant GC as "åƒåœ¾å›æ”¶"
Client->>DB : withSnapshot(...)
DB->>DB : getCurrentEpoch()
DB->>DB : pushPinnedEpoch(epoch)
loop é•¿æŸ¥è¯¢
Client->>DB : find(...).follow(...)
end
DB->>Compaction : autoCompact(dbPath, ...)
Compaction->>DB : è¯·æ±‚åˆå¹¶é¡µé¢
DB-->>Compaction : å…è®¸æ— å†²çª
DB->>GC : garbageCollectPages(dbPath, {respectReaders : true})
GC->>DB : æ‰«æ manifest
alt å­˜åœ¨æ´»åŠ¨è¯»å–å™¨
DB-->>GC : è·³è¿‡è¢« pin çš„ epoch é¡µé¢
else æ— æ´»åŠ¨è¯»å–å™¨
GC->>DB : é‡å†™æ–‡ä»¶ä»¥å›æ”¶ç©ºé—´
end
DB->>Client : è¿”å›ç¨³å®šç»“æœ
DB->>DB : popPinnedEpoch()
```

**Diagram sources**
- [query_snapshot_isolation.test.ts](file://tests/system/query_snapshot_isolation.test.ts#L1-L285)
- [persistentStore.ts](file://src/storage/persistentStore.ts#L1355-L1378)
- [synapseDb.ts](file://src/synapseDb.ts#L477-L491)

**Section sources**
- [query_snapshot_isolation.test.ts](file://tests/system/query_snapshot_isolation.test.ts#L1-L285)
- [persistentStore.ts](file://src/storage/persistentStore.ts#L1355-L1378)
- [synapseDb.ts](file://src/synapseDb.ts#L477-L491)

## å•å†™è€…å¹¶å‘æ§åˆ¶æœºåˆ¶
ä¸ºäº†é˜²æ­¢å¤šä¸ªå†™å…¥è¿›ç¨‹åŒæ—¶ä¿®æ”¹æ•°æ®åº“å¯¼è‡´æ•°æ®æŸåï¼ŒSynapseDB å®ç°äº†åŸºäºæ–‡ä»¶é”çš„å•å†™è€…ä¿æŠ¤æœºåˆ¶ï¼Œå…¶è¡Œä¸ºåœ¨ `concurrency_single_writer_guard.test.ts` ä¸­å¾—åˆ°å……åˆ†éªŒè¯ã€‚

### é”æœºåˆ¶å·¥ä½œæµç¨‹
1. **å¯ç”¨é”**ï¼šå½“ä»¥ `{enableLock: true}` æ‰“å¼€æ•°æ®åº“æ—¶ï¼Œç³»ç»Ÿä¼šåœ¨æ•°æ®åº“æ–‡ä»¶æ—åˆ›å»ºä¸€ä¸ª `.lock` æ–‡ä»¶ã€‚
2. **äº’æ–¥è®¿é—®**ï¼šåç»­å°è¯•ä»¥ç›¸åŒæ¨¡å¼æ‰“å¼€æ•°æ®åº“çš„è¿›ç¨‹ä¼šæ£€æŸ¥è¯¥é”æ–‡ä»¶çš„å­˜åœ¨ã€‚å¦‚æœå­˜åœ¨ï¼Œåˆ™æ‹’ç»è®¿é—®ï¼ŒæŠ›å‡ºé”™è¯¯ã€‚
3. **é‡Šæ”¾é”**ï¼šå½“å†™å…¥è¿›ç¨‹æ­£å¸¸å…³é—­æ•°æ®åº“æ—¶ï¼Œ`.lock` æ–‡ä»¶ä¼šè¢«è‡ªåŠ¨åˆ é™¤ã€‚
4. **è¯»è€…å…¼å®¹**ï¼šä¸å¯ç”¨é”çš„è¿›ç¨‹ï¼ˆå³è¯»è€…ï¼‰å¯ä»¥ä¸å†™è€…å…±å­˜ï¼Œåªè¦å®ƒä»¬ä¸è¿›è¡Œå†™æ“ä½œã€‚

### æµ‹è¯•è¦†ç›–çš„å…³é”®åœºæ™¯
- **å†™è€…äº’æ–¥**ï¼šç¬¬äºŒä¸ªå¯ç”¨é”çš„å†™è€…æ— æ³•æ‰“å¼€å·²è¢«é”å®šçš„æ•°æ®åº“ã€‚
- **é”é‡Šæ”¾åæ¥ç®¡**ï¼šç¬¬ä¸€ä¸ªå†™è€…å…³é—­åï¼Œç¬¬äºŒä¸ªå†™è€…å¯ä»¥æˆåŠŸè·å–é”å¹¶ç»§ç»­å†™å…¥ã€‚
- **æ··åˆæ¨¡å¼å…±å­˜**ï¼šå·²é”å®šçš„å†™è€…å…è®¸æ— é”çš„è¯»è€…è¿›ç¨‹æ‰“å¼€æ•°æ®åº“è¿›è¡ŒæŸ¥è¯¢ã€‚
- **é”æ–‡ä»¶æ¸…ç†**ï¼šéªŒè¯äº†æ•°æ®åº“å…³é—­åï¼Œé”æ–‡ä»¶æ˜¯å¦è¢«æ­£ç¡®æ¸…ç†ã€‚

æ­¤æœºåˆ¶ç¡®ä¿äº†æ•°æ®å†™å…¥çš„ä¸²è¡ŒåŒ–ï¼Œæ˜¯ä¿è¯æ•°æ®å®Œæ•´æ€§çš„åŸºç¡€ã€‚

```mermaid
flowchart TD
Start([å¼€å§‹]) --> OpenWriter["writer = open(dbPath, {enableLock: true})"]
OpenWriter --> CheckLock["æ£€æŸ¥ .lock æ–‡ä»¶æ˜¯å¦å­˜åœ¨"]
CheckLock --> |ä¸å­˜åœ¨| CreateLock["åˆ›å»º .lock æ–‡ä»¶"]
CreateLock --> Success["æˆåŠŸæ‰“å¼€æ•°æ®åº“"]
CheckLock --> |å­˜åœ¨| Fail["æ‹’ç»è®¿é—®ï¼ŒæŠ›å‡ºé”™è¯¯"]
Success --> CloseDB["writer.close()"]
CloseDB --> RemoveLock["åˆ é™¤ .lock æ–‡ä»¶"]
RemoveLock --> End([ç»“æŸ])
```

**Diagram sources**
- [concurrency_single_writer_guard.test.ts](file://tests/system/concurrency_single_writer_guard.test.ts#L1-L193)
- [synapseDb.ts](file://src/synapseDb.ts#L84-L108)
- [persistentStore.ts](file://src/storage/persistentStore.ts#L150-L180)

**Section sources**
- [concurrency_single_writer_guard.test.ts](file://tests/system/concurrency_single_writer_guard.test.ts#L1-L193)
- [synapseDb.ts](file://src/synapseDb.ts#L84-L108)
- [persistentStore.ts](file://src/storage/persistentStore.ts#L150-L180)

## å†…å­˜ä¼˜åŒ–ç­–ç•¥åœ¨é•¿æ—¶é—´è¿è¡Œä¸­çš„è¡¨ç°
`snapshot_memory_optimization.test.ts` æµ‹è¯•éªŒè¯äº†æ•°æ®åº“åœ¨é•¿æ—¶é—´è¿è¡Œå’Œå¤§æ•°æ®é›†æŸ¥è¯¢ä¸‹çš„å†…å­˜ç¨³å®šæ€§ã€‚è¯¥æµ‹è¯•é€šè¿‡ `withSnapshot` API æ‰§è¡Œæµå¼æŸ¥è¯¢ï¼Œå¹¶ç›‘æ§å †å†…å­˜ä½¿ç”¨æƒ…å†µã€‚

### æµ‹è¯•ç›®æ ‡
- éªŒè¯å¿«ç…§æŸ¥è¯¢ä¸ä¼šå¯¼è‡´å†…å­˜æŒç»­å¢é•¿ã€‚
- ç¡®ä¿æµå¼æŸ¥è¯¢åœ¨å¤„ç†å¤§é‡æ•°æ®æ—¶å†…å­˜å ç”¨ä¿æŒç¨³å®šã€‚
- è¯„ä¼°åå°ç»´æŠ¤ä»»åŠ¡ï¼ˆå‹ç¼©ã€GCï¼‰å¯¹å†…å­˜çš„å½±å“ã€‚

### å…³é”®å˜æ›´
æ ¹æ®æäº¤ `0eaf54fa24ce8e4be05a0e7bdf462b8d16c5517a`ï¼Œå·²å°†æµå¼æŸ¥è¯¢çš„å†…å­˜å¢é•¿éªŒæ”¶é˜ˆå€¼ä» 12MB è°ƒæ•´è‡³ 15MBï¼Œä»¥é€‚åº”ä¸åŒè¿è¡Œç¯å¢ƒï¼ˆå¦‚è¦†ç›–ç‡åˆ†æï¼‰ä¸‹çš„å¾®å°å¼€é”€ã€‚

### æµ‹è¯•åœºæ™¯
- **å¿«ç…§æŸ¥è¯¢å†…å­˜å ç”¨**ï¼šæµ‹è¯•åˆ›å»º 10000 æ¡è®°å½•åæ‰§è¡Œå¿«ç…§æŸ¥è¯¢ï¼ŒéªŒè¯å†…å­˜å¢é•¿ä¸è¶…è¿‡ 13MBã€‚
- **å¤§æ•°æ®é›†æµå¼æŸ¥è¯¢**ï¼šæµ‹è¯•åˆ›å»º 12000 æ¡è®°å½•åä½¿ç”¨ `findStream` è¿›è¡Œæµå¼æŸ¥è¯¢ï¼ŒéªŒè¯å†…å­˜å¢é•¿å§‹ç»ˆä½äº 15MBã€‚

```mermaid
graph TD
A[å¼€å§‹æµ‹è¯•] --> B[åˆ›å»ºæµ‹è¯•æ•°æ®åº“]
B --> C[æ‰¹é‡æ’å…¥ 12000 æ¡è®°å½•]
C --> D[è®°å½•åˆå§‹å†…å­˜]
D --> E[å¯åŠ¨å¿«ç…§]
E --> F[å¹¶å‘æ‰§è¡Œå‹ç¼©å’ŒGC]
F --> G[æ‰§è¡Œæµå¼æŸ¥è¯¢]
G --> H{æ¯å¤„ç†5000æ¡è®°å½•}
H --> I[æ£€æŸ¥å†…å­˜å¢é•¿ < 15MB]
I --> J[ç»§ç»­å¤„ç†]
J --> H
H --> K[æŸ¥è¯¢å®Œæˆ]
K --> L[è®°å½•æœ€ç»ˆå†…å­˜]
L --> M[éªŒè¯æ€»å¢é•¿ < 15MB]
M --> N[å…³é—­æ•°æ®åº“]
N --> O[æµ‹è¯•é€šè¿‡]
```

**Diagram sources**
- [snapshot_memory_optimization.test.ts](file://tests/system/snapshot_memory_optimization.test.ts#L1-L199)
- [synapseDb.ts](file://src/synapseDb.ts#L458-L460)
- [persistentStore.ts](file://src/storage/persistentStore.ts#L700-L720)

**Section sources**
- [snapshot_memory_optimization.test.ts](file://tests/system/snapshot_memory_optimization.test.ts#L1-L199) - *å·²æ›´æ–°ï¼šå†…å­˜é˜ˆå€¼è°ƒæ•´*
- [synapseDb.ts](file://src/synapseDb.ts#L458-L460)
- [persistentStore.ts](file://src/storage/persistentStore.ts#L700-L720)

## å´©æºƒæ³¨å…¥ä¸æ•…éšœæ¢å¤èƒ½åŠ›
`crash_injection.test.ts` æµ‹è¯•é€šè¿‡ `triggerCrash` å·¥å…·å‡½æ•°åœ¨å…³é”®è·¯å¾„ä¸Šæ¨¡æ‹Ÿè¿›ç¨‹å´©æºƒï¼ŒéªŒè¯æ•°æ®åº“çš„æ•…éšœæ¢å¤èƒ½åŠ›ã€‚

### å®ç°æœºåˆ¶
- **æ•…éšœç‚¹æ³¨å…¥**ï¼šåœ¨ WAL æäº¤ã€GC é‡å‘½åã€Manifest å†™å…¥ç­‰å…³é”®æ“ä½œå‰è°ƒç”¨ `triggerCrash`ã€‚
- **å¹‚ç­‰æ€§è®¾è®¡**ï¼šæ‰€æœ‰æ“ä½œè®¾è®¡ä¸ºå¹‚ç­‰ï¼Œç¡®ä¿å´©æºƒåé‡å¯èƒ½å®‰å…¨é‡æ”¾ã€‚
- **åŸå­æ€§ä¿è¯**ï¼šé€šè¿‡ä¸´æ—¶æ–‡ä»¶å’ŒåŸå­é‡å‘½åç¡®ä¿æ–‡ä»¶æ“ä½œçš„åŸå­æ€§ã€‚

### æµ‹è¯•è¦†ç›–
- **WAL æäº¤å´©æºƒ**ï¼šéªŒè¯æœªå®Œæˆçš„ WAL å†™å…¥ä¸ä¼šå¯¼è‡´æ•°æ®æŸåã€‚
- **GC é‡å‘½åå´©æºƒ**ï¼šéªŒè¯ä¸´æ—¶æ–‡ä»¶æ¸…ç†å’ŒçŠ¶æ€æ¢å¤ã€‚
- **Manifest å†™å…¥å´©æºƒ**ï¼šéªŒè¯å…ƒæ•°æ®çš„ä¸€è‡´æ€§ã€‚

æ­¤æµ‹è¯•ç¡®ä¿äº†æ•°æ®åº“åœ¨æ„å¤–ä¸­æ–­åèƒ½æ¢å¤åˆ°ä¸€è‡´çŠ¶æ€ã€‚

**Section sources**
- [crash_injection.test.ts](file://tests/system/crash_injection.test.ts#L1-L97)
- [fault.ts](file://src/utils/fault.ts#L1-L20)
- [wal.ts](file://src/storage/wal.ts#L200-L250)

## ç³»ç»Ÿæµ‹è¯•æ‰§è¡Œæ–¹å¼
ç³»ç»Ÿæµ‹è¯•ä½¿ç”¨ Vitest æ¡†æ¶æ‰§è¡Œï¼Œé€šè¿‡ä»¥ä¸‹å‘½ä»¤è¿è¡Œï¼š
```bash
pnpm test:coverage
```
æµ‹è¯•ä½¿ç”¨ä¸´æ—¶å·¥ä½œåŒºï¼ˆ`tempfs`ï¼‰éš”ç¦»ç¯å¢ƒï¼Œç¡®ä¿æµ‹è¯•çš„çº¯å‡€æ€§ã€‚å…³é”®æµ‹è¯•æ–‡ä»¶ä½äº `tests/system/` ç›®å½•ä¸‹ã€‚

## æ—¥å¿—åˆ†ææŠ€å·§
- **å†…å­˜å¢é•¿æ—¥å¿—**ï¼šå…³æ³¨ `ğŸ“ˆ å†…å­˜å¢é•¿` å’Œ `ğŸ“Š åˆå§‹/æŸ¥è¯¢åå†…å­˜ä½¿ç”¨` æ—¥å¿—ï¼Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨å†…å­˜æ³„æ¼ã€‚
- **ç»´æŠ¤æ“ä½œæ—¥å¿—**ï¼šæ£€æŸ¥ `å‹ç¼©æ“ä½œå®Œæˆ` å’Œ `GCæ“ä½œå®Œæˆ` æ—¥å¿—ï¼Œç¡®è®¤åå°ä»»åŠ¡æˆåŠŸæ‰§è¡Œã€‚
- **æ•…éšœæ³¨å…¥æ—¥å¿—**ï¼šåœ¨å´©æºƒæ¢å¤æµ‹è¯•ä¸­ï¼Œé¢„æœŸä¼šçœ‹åˆ° `ç»´æŠ¤æ“ä½œä¸­çš„é”™è¯¯ï¼ˆé¢„æœŸï¼‰` æ—¥å¿—ã€‚

## å¸¸è§å¤±è´¥æ¨¡å¼æ’æŸ¥æŒ‡å¼•
- **å†…å­˜æµ‹è¯•å¤±è´¥**ï¼šæ£€æŸ¥æ˜¯å¦åœ¨è¦†ç›–ç‡æ¨¡å¼ä¸‹è¿è¡Œï¼Œè°ƒæ•´ `recordCount` è§„æ¨¡ï¼›ç¡®è®¤æ— å…¶ä»–å†…å­˜å¯†é›†å‹æ“ä½œå¹²æ‰°ã€‚
- **å¿«ç…§éš”ç¦»å¤±è´¥**ï¼šæ£€æŸ¥ `pushPinnedEpoch` å’Œ `popPinnedEpoch` æ˜¯å¦æˆå¯¹è°ƒç”¨ï¼›ç¡®è®¤ GC æ˜¯å¦æ­£ç¡®å°Šé‡æ´»åŠ¨è¯»å–å™¨ã€‚
- **å´©æºƒæ¢å¤å¤±è´¥**ï¼šæ£€æŸ¥ `triggerCrash` æ³¨å…¥ç‚¹æ˜¯å¦è¦†ç›–æ‰€æœ‰å…³é”®è·¯å¾„ï¼›éªŒè¯ä¸´æ—¶æ–‡ä»¶æ¸…ç†é€»è¾‘ã€‚

## CI æ¸…ç†ç­–ç•¥
æ ¹æ®æäº¤ `2c3e25fc95b538d37314a9c0f44da5f9f7bc1230`ï¼ŒCI æµç¨‹å·²å¼ºåŒ–æ¸…ç†ç­–ç•¥ï¼Œé˜²æ­¢ä¸´æ—¶æ–‡ä»¶æ®‹ç•™ã€‚

### å®ç°æ–¹å¼
åœ¨ `.github/workflows/ci.yml` ä¸­æ·»åŠ äº†æ–­è¨€æ­¥éª¤ï¼Œæ£€æŸ¥å·¥ä½œåŒºæ ¹ç›®å½•æ˜¯å¦å­˜åœ¨ `tmp-*.synapsedb` ç­‰ä¸´æ—¶æ–‡ä»¶ã€‚è‹¥å‘ç°æ®‹ç•™ï¼Œåˆ™æ„å»ºå¤±è´¥ã€‚

### æ£€æŸ¥çš„æ–‡ä»¶ç±»å‹
- `tmp-*.synapsedb`
- `tmp-*.synapsedb.wal`
- `tmp-*.synapsedb.lock`
- `tmp-*.synapsedb.pages`

æ­¤æœºåˆ¶ç¡®ä¿äº†æ¯æ¬¡æ„å»ºåç¯å¢ƒçš„å¹²å‡€ï¼Œé¿å…äº†å› ä¸´æ—¶æ–‡ä»¶ç´¯ç§¯å¯¼è‡´çš„æ½œåœ¨é—®é¢˜ã€‚

**Section sources**
- [.github/workflows/ci.yml](file://.github/workflows/ci.yml#L60-L80) - *å·²æ›´æ–°ï¼šCI æ¸…ç†ç­–ç•¥*
- [tempfs.ts](file://tests/helpers/tempfs.ts#L16-L32) - *ä¸´æ—¶å·¥ä½œåŒºç®¡ç†*

## ç»“è®º
æœ¬ç³»ç»Ÿæµ‹è¯•æ–‡æ¡£è¯¦ç»†æè¿°äº† SynapseDB çš„æ ¸å¿ƒç¨³å®šæ€§ä¿éšœæœºåˆ¶ã€‚é€šè¿‡å¿«ç…§éš”ç¦»ã€å•å†™è€…æ§åˆ¶ã€å†…å­˜ä¼˜åŒ–å’Œå´©æºƒæ¢å¤ç­‰æµ‹è¯•ï¼Œå…¨é¢éªŒè¯äº†æ•°æ®åº“åœ¨å¤æ‚ç”Ÿäº§ç¯å¢ƒä¸‹çš„å¯é æ€§ã€‚è¿‘æœŸå¯¹å†…å­˜é˜ˆå€¼å’Œ CI æ¸…ç†ç­–ç•¥çš„æ›´æ–°ï¼Œè¿›ä¸€æ­¥å¢å¼ºäº†æµ‹è¯•çš„é²æ£’æ€§å’Œç¯å¢ƒçº¯å‡€åº¦ï¼Œä¸ºæ•°æ®åº“çš„ç¨³å®šè¿è¡Œæä¾›äº†åšå®ä¿éšœã€‚