# 基准测试套件

<cite>
**本文档中引用的文件**
- [basic.mjs](file://benchmarks/basic.mjs)
- [comprehensive.mjs](file://benchmarks/comprehensive.mjs)
- [framework.mjs](file://benchmarks/framework.mjs)
- [insert_scan.mjs](file://benchmarks/insert_scan.mjs)
- [path_agg.mjs](file://benchmarks/path_agg.mjs)
- [quick.mjs](file://benchmarks/quick.mjs)
</cite>

## 目录
1. [简介](#简介)
2. [基准测试脚本设计目的与使用场景](#基准测试脚本设计目的与使用场景)
3. [通用测试框架机制](#通用测试框架机制)
4. [各脚本运行方式与参数配置](#各脚本运行方式与参数配置)
5. [预期输出格式](#预期输出格式)
6. [内部实现逻辑分析](#内部实现逻辑分析)

## 简介
SynapseDB 提供了一套完整的基准测试工具集，用于评估数据库在不同工作负载下的性能表现。这些基准测试脚本覆盖了从基础写入到复杂图算法查询的多种场景，帮助开发者和运维人员快速验证系统性能基线、发现性能瓶颈并进行优化。

## 基准测试脚本设计目的与使用场景
### basic.mjs：基础写入吞吐量与简单查询延迟测试
该脚本主要用于测量系统的最基础性能指标，包括数据插入速度和简单的全表扫描查询延迟。它适合在新部署或配置变更后快速验证系统的基本性能是否达标。

**使用场景**：
- 新环境部署后的初始性能验证
- 配置调优前后的对比测试
- CI/CD 流水线中的基本性能回归检测

### comprehensive.mjs：综合混合负载稳定性测试
此脚本模拟真实世界中的混合负载情况，包含读写交织操作、事务提交、索引更新等复杂行为。通过多个测试套件组合，全面反映系统的整体稳定性和综合性能。

**使用场景**：
- 版本发布前的全面性能验收
- 高并发场景下的系统稳定性验证
- 复杂业务场景的端到端性能评估

### insert_scan.mjs：大规模数据插入后全表扫描性能测试
该脚本专注于评估大量数据插入后的 I/O 性能和缓存效率，特别是全表扫描操作的表现。这对于需要频繁进行大数据量扫描的应用尤为重要。

**使用场景**：
- 数据仓库类应用的性能评估
- 批量导入数据后的查询性能验证
- 存储引擎 I/O 效率和缓存策略的调优

### path_agg.mjs：图路径查找与聚合查询性能测试
针对图算法密集型应用场景设计，测试变长路径查询和流式聚合操作的性能表现。适用于社交网络分析、推荐系统等依赖复杂图遍历的业务。

**使用场景**：
- 社交关系链分析性能评估
- 推荐算法中多跳关联查询优化
- 图形数据库核心功能的压力测试

### quick.mjs：极简测试流程用于开发阶段快速迭代
提供一个轻量级的测试流程，仅包含核心功能的快速验证，便于开发过程中频繁执行以及时发现性能问题。

**使用场景**：
- 开发过程中的日常性能监控
- 代码重构后的即时性能反馈
- 资源受限环境下的快速性能检查

## 通用测试框架机制
### framework.mjs：基准测试框架核心机制
`framework.mjs` 文件定义了统一的基准测试接口和结果验证体系，为所有具体的测试脚本提供了标准化的支持。

#### 核心组件
- **Benchmark 类**：表示单个基准测试，包含名称、描述、设置函数、测试函数、清理函数和结果验证器。
- **BenchmarkSuite 类**：组织多个相关测试的套件，支持全局设置和清理操作。
- **BenchmarkRunner 类**：负责运行测试套件，自动处理预热、多次测量、GC 控制等细节。
- **PerformanceValidator 工具类**：提供常用的结果验证方法，如结果数量校验、时间限制检查等。

#### 运行机制
1. **预热阶段**：执行若干次测试以消除 JIT 编译等因素的影响
2. **测量阶段**：多次运行测试并收集性能数据（时间、内存）
3. **结果验证**：根据预设条件验证测试结果的正确性
4. **报告生成**：汇总统计信息并输出详细报告

这种分层架构使得新增测试变得非常简单，只需关注业务逻辑本身，而无需重复处理性能测量的底层细节。

## 各脚本运行方式与参数配置
### 基本运行命令
```bash
node benchmarks/basic.mjs
node benchmarks/comprehensive.mjs
node benchmarks/insert_scan.mjs [N=20000]
node benchmarks/path_agg.mjs
node benchmarks/quick.mjs
```

### 参数说明
| 脚本 | 可配置参数 | 默认值 | 说明 |
|------|-----------|--------|------|
| insert_scan.mjs | N | 20000 | 指定要插入的数据条数 |
| comprehensive.mjs | --verbose | false | 启用详细日志输出 |
| comprehensive.mjs | --expose-gc | false | 启用垃圾回收测量 |

### 特殊运行选项
- `--expose-gc`：Node.js 启动参数，暴露全局 gc 函数以便精确控制垃圾回收
- `--verbose`：启用详细的运行日志，显示每次预热和测量的过程

## 预期输出格式
所有基准测试脚本均采用统一的日志输出格式，确保结果易于解析和比较。

### 基础输出结构
```
BENCH <测试名称>: <耗时>ms
```

### 详细输出示例（comprehensive.mjs）
```
🎯 SynapseDB v1.1 综合性能基准测试
====================================
Node.js: v18.17.0
平台: darwin x64
CPU核心: 8
可用内存: 16GB

🚀 运行基准套件: 数据插入性能测试
   测试不同规模数据的插入性能和内存使用

📊 小规模批量插入
   插入 1,000 条三元组
   ⏱️  平均耗时: 12.34ms
   💾 平均内存: 1.2 MB
   ✅ 结果验证: 通过

📈 基准测试摘要 - 数据插入性能测试
   总数: 3
   成功: 3
   失败: 0
   总耗时: 45ms
   平均耗时: 15.23ms
   最快: 小规模批量插入 (12.34ms)
   最慢: 中规模批量插入 (18.56ms)
```

### JSON 报告输出
`comprehensive.mjs` 在测试完成后会生成 `benchmark-report.json` 文件，包含完整的测试结果和环境信息，可用于后续分析和历史对比。

## 内部实现逻辑分析
### 测试生命周期管理
每个测试脚本都遵循标准的生命周期：初始化 → 设置 → 执行 → 清理 → 输出结果。利用 Node.js 的临时目录 API 创建隔离的测试环境，确保测试之间互不干扰。

### 性能测量精度保障
- 使用 `performance.now()` 获取高精度时间戳
- 支持 GC 控制，减少垃圾回收对测量结果的影响
- 多次测量取平均值，提高结果可靠性

### 资源管理
- 自动创建和删除临时工作区
- 显式关闭数据库连接释放资源
- 异常情况下也能保证资源正确清理

### 错误处理与健壮性
- 全局异常处理器捕获未预期错误
- 每个测试独立运行，失败不影响其他测试
- 提供清晰的错误信息便于问题定位

**Section sources**
- [basic.mjs](file://benchmarks/basic.mjs)
- [comprehensive.mjs](file://benchmarks/comprehensive.mjs)
- [framework.mjs](file://benchmarks/framework.mjs)
- [insert_scan.mjs](file://benchmarks/insert_scan.mjs)
- [path_agg.mjs](file://benchmarks/path_agg.mjs)
- [quick.mjs](file://benchmarks/quick.mjs)