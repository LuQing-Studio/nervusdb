# 性能调优建议

<cite>
**本文档引用文件**  
- [persistentStore.ts](file://src/storage/persistentStore.ts)
- [wal.ts](file://src/storage/wal.ts)
</cite>

## 目录
1. [高写入负载优化策略](#高写入负载优化策略)
2. [I/O效率提升配置](#io效率提升配置)
3. [压缩与存储空间管理](#压缩与存储空间管理)
4. [查询性能优化](#查询性能优化)
5. [持久性与性能平衡](#持久性与性能平衡)
6. [部署环境验证](#部署环境验证)

## 高写入负载优化策略

在高写入负载场景下，为减少动态扩展开销，建议预分配存储空间。SynapseDB通过分页索引机制管理数据存储，当数据库初始化或重建索引时，会根据配置的页大小（pageSize）进行数据分页。通过预先设置合适的存储容量和页大小，可有效避免频繁的文件扩展操作，从而降低I/O开销。

**Section sources**
- [persistentStore.ts](file://src/storage/persistentStore.ts#L46-L59)

## I/O效率提升配置

为提升I/O效率，应调整页大小（page size）和段大小（segment size）以匹配底层文件系统的块对齐特性。在`PersistentStoreOptions`配置中，`pageSize`参数控制分页索引的页面大小，默认值由`DEFAULT_PAGE_SIZE`常量定义。建议将页大小设置为文件系统块大小的整数倍（如4KB、8KB等），以确保数据读写时的物理对齐，减少不必要的磁盘寻道和读取放大。

**Section sources**
- [persistentStore.ts](file://src/storage/persistentStore.ts#L259-L314)

## 压缩与存储空间管理

启用Brotli压缩选项可显著降低磁盘占用并减少读取延迟。在`PersistentStoreOptions`中，`compression`字段支持配置压缩算法：
```typescript
compression?: {
  codec: 'none' | 'brotli';
  level?: number;
};
```
建议在存储空间受限或I/O带宽有限的环境中启用`brotli`压缩，并根据性能需求调整压缩级别（level）。较高的压缩级别可获得更好的空间利用率，但会增加CPU开销。需根据实际硬件配置权衡选择。

**Section sources**
- [persistentStore.ts](file://src/storage/persistentStore.ts#L50-L53)
- [pagedIndex.ts](file://src/storage/pagedIndex.ts#L28-L129)

## 查询性能优化

对于查询密集型应用，应合理构建属性索引以加速WHERE条件过滤，同时避免过度索引导致写放大。在路径查找或聚合查询时，应控制返回结果集规模，利用LIMIT进行分页处理。流式查询接口`streamQuery`和`streamFactRecords`支持分批处理大规模结果集，避免内存溢出。

属性索引的创建和维护应在数据写入模式稳定后进行，避免在高频写入期间频繁重建索引。通过`PropertyIndexManager`实现的索引机制，可在不影响主写入路径的前提下异步更新索引数据。

**Section sources**
- [persistentStore.ts](file://src/storage/persistentStore.ts#L799-L1665)

## 持久性与性能平衡

结合`persistentStore.ts`和`wal.ts`中的配置项，可平衡持久性保证与性能损耗。WAL（Write-Ahead Log）机制通过`WalWriter`类实现，提供两种提交模式：
- `appendCommit()`：异步提交，性能较高
- `appendCommitDurable()`：同步提交，确保数据持久化

在高吞吐场景下，可采用异步提交以提高写入速度；在需要强持久性保证的场景下，应使用`appendCommitDurable()`确保WAL记录已刷入磁盘。此外，`enableLock`选项可启用进程级独占写锁，防止并发写入冲突。

**Section sources**
- [wal.ts](file://src/storage/wal.ts#L105-L108)
- [persistentStore.ts](file://src/storage/persistentStore.ts#L46-L59)

## 部署环境验证

建议用户在目标部署环境中实测调优效果，确保建议落地可行。不同硬件配置（如SSD vs HDD）、操作系统和文件系统对最佳参数选择有显著影响。应通过基准测试套件（位于`benchmarks/`目录）验证各项优化策略的实际收益，包括`comprehensive.mjs`中的综合性能测试和`insert_scan.mjs`中的插入扫描性能测试。

**Section sources**
- [comprehensive.mjs](file://benchmarks/comprehensive.mjs#L0-L54)
- [insert_scan.mjs](file://benchmarks/insert_scan.mjs)