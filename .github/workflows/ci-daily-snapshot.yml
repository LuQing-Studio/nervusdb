name: CI Daily Snapshot

on:
  schedule:
    - cron: "50 1 * * *"
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ci-daily-snapshot-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci-daily-snapshot:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: cargo-ci-daily-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Check formatting
        id: fmt
        continue-on-error: true
        run: |
          mkdir -p artifacts/tck
          LOG_FILE="artifacts/tck/ci-daily-$(date -u +%F).log"
          echo "[fmt] start $(date -u +%Y-%m-%dT%H:%M:%SZ)" | tee -a "$LOG_FILE"
          cargo fmt --all -- --check 2>&1 | tee -a "$LOG_FILE"

      - name: Clippy
        id: clippy
        continue-on-error: true
        run: |
          mkdir -p artifacts/tck
          LOG_FILE="artifacts/tck/ci-daily-$(date -u +%F).log"
          echo "[clippy] start $(date -u +%Y-%m-%dT%H:%M:%SZ)" | tee -a "$LOG_FILE"
          cargo clippy --workspace --exclude nervusdb-pyo3 --all-targets -- -W warnings 2>&1 | tee -a "$LOG_FILE"

      - name: Runtime guard hotspot audit
        id: runtime_guard
        continue-on-error: true
        run: |
          mkdir -p artifacts/tck
          LOG_FILE="artifacts/tck/ci-daily-$(date -u +%F).log"
          echo "[runtime-guard] start $(date -u +%Y-%m-%dT%H:%M:%SZ)" | tee -a "$LOG_FILE"
          bash scripts/runtime_guard_audit.sh --fail-on-hotspot 2>&1 | tee -a "$LOG_FILE"

      - name: Run workspace quick tests
        id: workspace_quick
        continue-on-error: true
        run: |
          mkdir -p artifacts/tck
          LOG_FILE="artifacts/tck/ci-daily-$(date -u +%F).log"
          echo "[workspace-quick] start $(date -u +%Y-%m-%dT%H:%M:%SZ)" | tee -a "$LOG_FILE"
          bash scripts/workspace_quick_test.sh 2>&1 | tee -a "$LOG_FILE"

      - name: TCK Tier-0
        id: tier0
        continue-on-error: true
        run: |
          mkdir -p artifacts/tck
          LOG_FILE="artifacts/tck/ci-daily-$(date -u +%F).log"
          echo "[tier0] start $(date -u +%Y-%m-%dT%H:%M:%SZ)" | tee -a "$LOG_FILE"
          bash scripts/tck_tier_gate.sh tier0 2>&1 | tee -a "$LOG_FILE"

      - name: TCK Tier-1
        id: tier1
        continue-on-error: true
        run: |
          mkdir -p artifacts/tck
          LOG_FILE="artifacts/tck/ci-daily-$(date -u +%F).log"
          echo "[tier1] start $(date -u +%Y-%m-%dT%H:%M:%SZ)" | tee -a "$LOG_FILE"
          bash scripts/tck_tier_gate.sh tier1 2>&1 | tee -a "$LOG_FILE"

      - name: TCK Tier-2
        id: tier2
        continue-on-error: true
        run: |
          mkdir -p artifacts/tck
          LOG_FILE="artifacts/tck/ci-daily-$(date -u +%F).log"
          echo "[tier2] start $(date -u +%Y-%m-%dT%H:%M:%SZ)" | tee -a "$LOG_FILE"
          bash scripts/tck_tier_gate.sh tier2 2>&1 | tee -a "$LOG_FILE"

      - name: Binding smoke
        id: binding
        continue-on-error: true
        run: |
          mkdir -p artifacts/tck
          LOG_FILE="artifacts/tck/ci-daily-$(date -u +%F).log"
          echo "[binding-smoke] start $(date -u +%Y-%m-%dT%H:%M:%SZ)" | tee -a "$LOG_FILE"
          bash scripts/binding_smoke.sh 2>&1 | tee -a "$LOG_FILE"

      - name: Contract smoke
        id: contract
        continue-on-error: true
        run: |
          mkdir -p artifacts/tck
          LOG_FILE="artifacts/tck/ci-daily-$(date -u +%F).log"
          echo "[contract-smoke] start $(date -u +%Y-%m-%dT%H:%M:%SZ)" | tee -a "$LOG_FILE"
          bash scripts/contract_smoke.sh 2>&1 | tee -a "$LOG_FILE"

      - name: Build daily snapshot report
        id: snapshot
        if: always()
        run: |
          mkdir -p artifacts/tck
          DATE_UTC="$(date -u +%F)"
          LOG_FILE="artifacts/tck/ci-daily-${DATE_UTC}.log"
          JSON_FILE="artifacts/tck/ci-daily-${DATE_UTC}.json"

          fmt='${{ steps.fmt.outcome }}'
          clippy='${{ steps.clippy.outcome }}'
          runtime_guard='${{ steps.runtime_guard.outcome }}'
          workspace_quick='${{ steps.workspace_quick.outcome }}'
          tier0='${{ steps.tier0.outcome }}'
          tier1='${{ steps.tier1.outcome }}'
          tier2='${{ steps.tier2.outcome }}'
          binding='${{ steps.binding.outcome }}'
          contract='${{ steps.contract.outcome }}'

          all_passed=true
          for status in "$fmt" "$clippy" "$runtime_guard" "$workspace_quick" "$tier0" "$tier1" "$tier2" "$binding" "$contract"; do
            if [ "$status" != "success" ]; then
              all_passed=false
            fi
          done

          cat > "$JSON_FILE" <<JSON
          {
            "date": "${DATE_UTC}",
            "generated_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "workflow": "ci-daily-snapshot.yml",
            "run_id": ${{ github.run_id }},
            "run_number": ${{ github.run_number }},
            "all_passed": ${all_passed},
            "checks": {
              "fmt": "${fmt}",
              "clippy": "${clippy}",
              "runtime_guard": "${runtime_guard}",
              "workspace_quick": "${workspace_quick}",
              "tier0": "${tier0}",
              "tier1": "${tier1}",
              "tier2": "${tier2}",
              "binding": "${binding}",
              "contract": "${contract}"
            }
          }
          JSON

          {
            echo "[snapshot] generated_at $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo "[snapshot] json: ${JSON_FILE}"
            echo "[snapshot] all_passed=${all_passed}"
          } | tee -a "$LOG_FILE"

          echo "all_passed=${all_passed}" >> "$GITHUB_OUTPUT"

      - name: Upload CI daily snapshot artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-daily-snapshot-artifacts
          path: |
            artifacts/tck/ci-daily-*.json
            artifacts/tck/ci-daily-*.log

      - name: Fail when any gate failed
        if: always()
        run: |
          if [ "${{ steps.snapshot.outputs.all_passed }}" != "true" ]; then
            echo "[ci-daily-snapshot] BLOCKED: one or more gates failed" >&2
            exit 1
          fi
          echo "[ci-daily-snapshot] PASSED"
